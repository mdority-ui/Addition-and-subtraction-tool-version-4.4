<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Base Ten Blocks: Decimals</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 20px;
        text-align: center;
        background-color: #f4f4f9;
        color: #333;
    }
    .main-container {
        max-width: 1200px;
        margin: auto;
    }
    .workspace-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-top: 20px;
    }
    .main-content {
        flex: 1;
    }
    .side-panel {
        width: 130px;
        position: -webkit-sticky;
        position: sticky;
        top: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .block-palette {
        width: 100%;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        box-sizing: border-box;
    }
    .problem-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    .number-row {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 5px;
        width: 100%;
        position: relative;
    }
    .carry-box {
        height: 35px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .carry-input {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid #e74c3c;
        text-align: center;
        font-size: 1em;
        font-weight: bold;
        color: #e74c3c;
        background-color: #fff5f5;
    }
    .subtraction-mode .carry-box {
        display: none;
    }
    .operation-symbol, .decimal-point {
        font-size: 2em;
        font-weight: bold;
        width: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding-bottom: 20px;
    }
    .operation-symbol {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        gap: 2px;
        width: 80px;
    }
    .op-instructions {
        font-size: 10px;
        color: #666;
        font-weight: normal;
    }
    .decimal-point {
        padding-bottom: 4px; /* Align with bottom of input box */
        width: 10px;
    }
    .place-value-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    
    .hundreds-group { width: 210px; }
    .tens-group { width: 150px; }
    .ones-group { width: 150px; }
    .tenths-group { width: 230px; }
    .hundredths-group { width: 230px; }

    .column {
        min-height: 120px;
        width: 100%;
        border: 2px dashed #ccc;
        padding: 5px;
        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        gap: 4px;
        border-radius: 5px;
        background-color: white;
        box-sizing: border-box;
    }
    .digit-input {
        font-size: 1.3em;
        width: 100%;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        background-color: #f8f9fa;
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    .block {
        cursor: grab;
        box-sizing: border-box;
        transition: background-color 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1a1a1a;
        border: 1px solid #333;
        touch-action: none; /* Prevent scrolling when dragging on touch devices */
    }
    .block.dragging {
        opacity: 0.0;
    }
    .block:active {
        cursor: grabbing;
    }
    
    .hundreds {
        background-color: #3498db;
        width: 60px;
        height: 60px;
        background-image:
            repeating-linear-gradient(to right, transparent, transparent 5px, #333 5px, #333 6px),
            repeating-linear-gradient(to bottom, transparent, transparent 5px, #333 5px, #333 6px);
    }
    .tens {
        background-color: #2ecc71;
        width: 10px;
        height: 60px;
        background-image: repeating-linear-gradient(to bottom, transparent, transparent 5px, #333 5px, #333 6px);
    }
    .ones {
        background-color: #f1c40f;
        width: 10px;
        height: 10px;
    }
    .tenths, .hundredths {
        width: 18px;
        height: 18px;
        font-size: 10px;
        font-weight: bold;
        border-radius: 2px;
    }
    .tenths {
        background-color: #9b59b6;
    }
    .hundredths {
        background-color: #e67e22;
    }

    .answer-section {
        margin-top: 20px;
        padding: 20px;
        background-color: #e9ecef;
        border-radius: 8px;
        width: 100%;
        box-sizing: border-box;
    }
    hr {
        width: 100%;
        border: 2px solid black;
    }
    #operation {
        font-size: 2em;
        font-weight: bold;
        border: none;
        background-color: transparent;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        text-align: center;
        cursor: pointer;
    }
    .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }
    .controls button {
        width: auto;
        flex-grow: 1;
        max-width: 250px;
    }

    button {
        font-size: 1em;
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        box-sizing: border-box;
    }
    button:hover {
        background-color: #0056b3;
    }
    #clearAllBtn { background-color: #6c757d; }
    #clearAllBtn:hover { background-color: #5a6268; }
    #clearAnswerBtn { background-color: #f0ad4e; }
    #clearAnswerBtn:hover { background-color: #ec971f; }
    .feedback {
        margin-top: 15px;
        font-size: 1.5em;
        font-weight: bold;
        height: 30px;
    }
    .correct { color: #2ecc71; }
    .incorrect { color: #e74c3c; }
    .improper { color: #f39c12; }
    
    .block-anim {
        position: fixed;
        animation-duration: 1s;
        animation-timing-function: cubic-bezier(0.25, 1, 0.5, 1);
        animation-fill-mode: forwards;
        pointer-events: none;
        z-index: 100;
    }
    @keyframes borrow-explode {
        from { transform: translate(0, 0) scale(1); opacity: 1; }
        to { transform: var(--explode-transform); opacity: 0; }
    }

    #trash-can {
        width: 100%;
        padding: 20px;
        font-size: 3em;
        border: 3px dashed #ccc;
        border-radius: 8px;
        color: #ccc;
        box-sizing: border-box;
        transition: background-color 0.2s, color 0.2s;
    }
    #trash-can.active {
        background-color: #ffdddd;
        color: #e74c3c;
    }
    .column-label {
        font-weight: bold;
        color: #555;
        margin-bottom: 5px;
        transition: opacity 0.3s, height 0.3s, margin 0.3s;
        overflow: hidden;
        height: 21px;
    }
    .labels-hidden .column-label {
        opacity: 0;
        height: 0;
        margin-bottom: 0;
    }
</style>
</head>
<body>

<div class="main-container">
    <h1>Interactive Base Ten Blocks: Decimals</h1>
    <p>Drag blocks to build numbers. Drag between columns to borrow or carry across place values!</p>

    <div class="workspace-container">
        <div class="main-content">
            </div>
        <div class="side-panel">
            </div>
    </div>
</div>

<script>
    let draggedElementInfo = null;
    let lastTouchTarget = null;
    const PLACES = ['hundreds', 'tens', 'ones', 'tenths', 'hundredths'];
    const PLACE_VALUES = { hundreds: 100, tens: 10, ones: 1, tenths: 0.1, hundredths: 0.01 };

    // --- Core Functions ---
    function toggleCarryRow() {
        const op = document.getElementById('operation').value;
        const row1 = document.getElementById('row1');
        if (op === '+') {
            row1.classList.remove('subtraction-mode');
        } else {
            row1.classList.add('subtraction-mode');
        }
    }

    function updateDigitsFromBlocks(rowId) { if (!rowId) return; const rowElement = document.getElementById(rowId); if(!rowElement) return; const prefix = rowId.startsWith('row1') ? 'num1' : rowId.startsWith('row2') ? 'num2' : 'ans'; PLACES.forEach(p => { const input = document.getElementById(`${prefix}-${p}`); if(input) input.value = rowElement.querySelector(`.column[data-place="${p}"]`).children.length; }); }
    function updateBlocksFromInputs(prefix, rowId) { if (!prefix || !rowId) return; const rowElement = document.getElementById(rowId); PLACES.forEach(p => { const count = parseInt(document.getElementById(`${prefix}-${p}`).value, 10) || 0; const col = rowElement.querySelector(`.column[data-place="${p}"]`); if (col) { col.innerHTML = ''; for (let i = 0; i < count; i++) addBlock(col, p); } }); }
    
    function generateBlocks(number, rowElement) {
        if (!rowElement) return;
        PLACES.forEach(p => {
            const col = rowElement.querySelector(`.column[data-place="${p}"]`);
            if (col) col.innerHTML = '';
        });
        let n = Math.max(0, number);
        const integerPart = Math.floor(n);
        const h = Math.floor(integerPart / 100);
        const t = Math.floor((integerPart % 100) / 10);
        const o = integerPart % 10;
        const n_str = n.toFixed(2);
        const decimal_str = n_str.split('.')[1] || "00";
        const tth = parseInt(decimal_str.charAt(0), 10);
        const hth = parseInt(decimal_str.charAt(1), 10);
        const counts = { hundreds: h, tens: t, ones: o, tenths: tth, hundredths: hth };
        PLACES.forEach(p => {
            const col = rowElement.querySelector(`.column[data-place="${p}"]`);
            if (col) {
                for (let i = 0; i < counts[p]; i++) addBlock(col, p);
            }
        });
    }
    
    function addBlock(container, type) { const block = document.createElement('div'); block.className = `block ${type}`; block.draggable = true; block.dataset.type = type; if (type === 'tenths') block.textContent = '.1'; if (type === 'hundredths') block.textContent = '.01'; container.appendChild(block); }
    function nextProblem() { const op = document.getElementById('operation').value; let n1 = parseFloat(((Math.random() * 899) + 100).toFixed(2)); let n2 = parseFloat(((Math.random() * (n1 * 0.8)) + 1).toFixed(2)); if (op === '-') { if (n1 < n2) [n1, n2] = [n2, n1]; } ['row1', 'row2', 'answerRow'].forEach(r => { const num = r === 'row1' ? n1 : (r === 'row2' ? n2 : 0); generateBlocks(num, document.getElementById(r)); updateDigitsFromBlocks(r); }); PLACES.forEach(p => { document.getElementById(`ans-${p}`).value = ''; }); document.getElementById('feedback').textContent = ''; document.querySelectorAll('.carry-input').forEach(input => input.value = ''); }
    function checkAnswer() {
        const getNum = p => PLACES.reduce((sum, place) => sum + (parseInt(document.getElementById(`${p}-${place}`).value, 10) || 0) * PLACE_VALUES[place], 0);
        const num1 = getNum('num1');
        const num2 = getNum('num2');
        const userAnsRow = document.getElementById('answerRow');
        const userAnsVal = PLACES.reduce((sum, p) => sum + userAnsRow.querySelector(`.column[data-place="${p}"]`).children.length * PLACE_VALUES[p], 0);
        const correctAns = document.getElementById('operation').value === '+' ? num1 + num2 : num1 - num2;
        const fb = document.getElementById('feedback');
        if (Math.abs(userAnsVal - correctAns) < 0.001) {
            const needsLowerRegrouping = ['tens', 'ones', 'tenths', 'hundredths'].some(p => userAnsRow.querySelector(`.column[data-place="${p}"]`).children.length >= 10);
            if (userAnsVal >= 1000) {
                if (needsLowerRegrouping) { fb.textContent = 'Correct value, but regrouping needed!'; fb.className = 'feedback improper'; } 
                else { fb.textContent = `Wow, ${userAnsVal.toFixed(2)}! Your answer is correct and too big for the board! 🎉`; fb.className = 'feedback correct'; }
            } else {
                const isImproper = needsLowerRegrouping || userAnsRow.querySelector(`.column[data-place="hundreds"]`).children.length >= 10;
                if (isImproper) { fb.textContent = 'Correct value, but regrouping needed!'; fb.className = 'feedback improper'; } 
                else { fb.textContent = 'Perfect! 🎉'; fb.className = 'feedback correct'; }
            }
        } else { fb.textContent = 'Not quite, check your total!'; fb.className = 'feedback incorrect'; }
    }
    function clearAll() { document.querySelectorAll('.column').forEach(col => col.innerHTML = ''); document.querySelectorAll('.digit-input').forEach(input => input.value = ''); document.getElementById('feedback').textContent = ''; document.querySelectorAll('.carry-input').forEach(input => input.value = ''); }
    function clearAnswer() { document.querySelectorAll('#answerRow .column').forEach(col => col.innerHTML = ''); document.querySelectorAll('#answerRow .digit-input').forEach(input => input.value = ''); document.querySelectorAll('.carry-input').forEach(input => input.value = ''); document.getElementById('feedback').textContent = ''; }

    // --- Animation Functions ---
    function animateExchange(fromBlock, toColumn, exchangeRate, newBlockType) { const fromRect = fromBlock.getBoundingClientRect(); fromBlock.remove(); for (let i = 0; i < exchangeRate; i++) { const tempBlock = document.createElement('div'); tempBlock.className = `block ${newBlockType} block-anim`; document.body.appendChild(tempBlock); tempBlock.style.left = `${fromRect.left}px`; tempBlock.style.top = `${fromRect.top}px`; const toRect = toColumn.getBoundingClientRect(); const finalX = toRect.left + (toRect.width / 2) + (Math.random() - 0.5) * toRect.width * 0.8; const finalY = toRect.top + (toRect.height / 2) + (Math.random() - 0.5) * toRect.height * 0.8; tempBlock.style.setProperty('--explode-transform', `translate(${finalX - fromRect.left}px, ${finalY - fromRect.top}px)`); tempBlock.style.animationName = 'borrow-explode'; } setTimeout(() => { document.querySelectorAll('.block-anim').forEach(b => b.remove()); for (let i = 0; i < exchangeRate; i++) addBlock(toColumn, newBlockType); updateDigitsFromBlocks(toColumn.dataset.rowId); }, 950); }
    function animateCarry(fromColumn, toColumn, exchangeRate, newBlockType) { const blocksToAnimate = Array.from(fromColumn.children).slice(0, exchangeRate); const toRect = toColumn.getBoundingClientRect(); blocksToAnimate.forEach(block => { const startRect = block.getBoundingClientRect(); const tempBlock = block.cloneNode(true); tempBlock.classList.add('block-anim'); document.body.appendChild(tempBlock); tempBlock.style.left = `${startRect.left}px`; tempBlock.style.top = `${startRect.top}px`; const finalX = toRect.left + toRect.width / 2 - tempBlock.offsetWidth / 2; const finalY = toRect.top + toRect.height / 2 - tempBlock.offsetHeight / 2; tempBlock.style.setProperty('--explode-transform', `translate(${finalX - startRect.left}px, ${finalY - startRect.top}px) scale(0.2)`); tempBlock.style.animationName = 'borrow-explode'; }); blocksToAnimate.forEach(block => block.remove()); setTimeout(() => { document.querySelectorAll('.block-anim').forEach(b => b.remove()); addBlock(toColumn, newBlockType); updateDigitsFromBlocks(fromColumn.dataset.rowId); updateDigitsFromBlocks(toColumn.dataset.rowId); }, 950); }
    function animateCarryToCircle(fromColumn, carryInput, exchangeRate) { const blocksToAnimate = Array.from(fromColumn.children).slice(0, exchangeRate); const toRect = carryInput.getBoundingClientRect(); blocksToAnimate.forEach(block => { const startRect = block.getBoundingClientRect(); const tempBlock = block.cloneNode(true); tempBlock.classList.add('block-anim'); document.body.appendChild(tempBlock); tempBlock.style.left = `${startRect.left}px`; tempBlock.style.top = `${startRect.top}px`; const finalX = toRect.left + toRect.width / 2 - tempBlock.offsetWidth / 2; const finalY = toRect.top + toRect.height / 2 - tempBlock.offsetHeight / 2; tempBlock.style.setProperty('--explode-transform', `translate(${finalX - startRect.left}px, ${finalY - startRect.top}px) scale(0.1)`); tempBlock.style.animationName = 'borrow-explode'; }); blocksToAnimate.forEach(block => block.remove()); setTimeout(() => { document.querySelectorAll('.block-anim').forEach(b => b.remove()); const currentVal = parseInt(carryInput.value, 10) || 0; carryInput.value = currentVal + 1; updateDigitsFromBlocks(fromColumn.dataset.rowId); }, 950); }
    function animatePaletteExchange(toColumn, fromType, dropX, dropY) { const toPlace = toColumn.dataset.place; const fromValue = PLACE_VALUES[fromType]; const toValue = PLACE_VALUES[toPlace]; if (fromValue <= toValue) return; const exchangeRate = Math.round(fromValue / toValue); for (let i = 0; i < exchangeRate; i++) { const tempBlock = document.createElement('div'); tempBlock.className = `block ${toPlace} block-anim`; document.body.appendChild(tempBlock); tempBlock.style.left = `${dropX - (tempBlock.offsetWidth / 2)}px`; tempBlock.style.top = `${dropY - (tempBlock.offsetHeight / 2)}px`; const toRect = toColumn.getBoundingClientRect(); const finalX = toRect.left + (toRect.width / 2) + (Math.random() - 0.5) * toRect.width * 0.8; const finalY = toRect.top + (toRect.height / 2) + (Math.random() - 0.5) * toRect.height * 0.8; tempBlock.style.setProperty('--explode-transform', `translate(${finalX - dropX}px, ${finalY - dropY}px)`); tempBlock.style.animationName = 'borrow-explode'; } setTimeout(() => { document.querySelectorAll('.block-anim').forEach(b => b.remove()); for (let i = 0; i < exchangeRate; i++) { addBlock(toColumn, toPlace); } updateDigitsFromBlocks(toColumn.dataset.rowId); }, 950); }

    // --- Drop Logic (re-used by mouse and touch) ---
    function executeDrop(target, draggedInfo, clientX, clientY) {
        if (!target || !draggedInfo) return;

        const trashCan = document.getElementById('trash-can');
        if (target === trashCan) {
            if (draggedInfo && !draggedInfo.source) {
                draggedInfo.element.remove();
                updateDigitsFromBlocks(draggedInfo.fromRowId);
            }
            return;
        }

        const toColumn = target.classList.contains('column') ? target : target.closest('.column');
        if (toColumn) {
            if (draggedInfo.source === 'palette') {
                if (draggedInfo.type === toColumn.dataset.place) {
                    addBlock(toColumn, draggedInfo.type);
                    updateDigitsFromBlocks(toColumn.dataset.rowId);
                } else {
                    animatePaletteExchange(toColumn, draggedInfo.type, clientX, clientY);
                }
            } else {
                const fromColumn = draggedInfo.element.parentElement;
                const fromPlace = fromColumn.dataset.place;
                const toPlace = toColumn.dataset.place;
                if (fromColumn.dataset.rowId !== toColumn.dataset.rowId) return;
                const fromValue = PLACE_VALUES[fromPlace];
                const toValue = PLACE_VALUES[toPlace];
                if (fromValue > toValue) { const exchangeRate = Math.round(fromValue / toValue); animateExchange(draggedInfo.element, toColumn, exchangeRate, toPlace); } 
                else if (fromValue < toValue) { const exchangeRate = Math.round(toValue / fromValue); if (fromColumn.children.length >= exchangeRate) { animateCarry(fromColumn, toColumn, exchangeRate, toPlace); } }
            }
            return;
        }

        const carryBox = target.classList.contains('carry-box') ? target : target.closest('.carry-box');
        if (carryBox) {
            const fromColumn = draggedInfo.element.parentElement;
            if (fromColumn.dataset.rowId !== 'answerRow') return;

            const fromPlace = fromColumn.dataset.place;
            const carryInput = carryBox.querySelector('.carry-input');
            if (!carryInput) return;
            const toPlace = carryInput.dataset.place;
            const fromIndex = PLACES.indexOf(fromPlace);
            const toIndex = PLACES.indexOf(toPlace);

            if (fromIndex === toIndex + 1) { 
                const exchangeRate = 10;
                if (fromColumn.children.length >= exchangeRate) {
                    animateCarryToCircle(fromColumn, carryInput, exchangeRate);
                }
            }
        }
    }

    // --- Touch Event Handlers ---
    function handleTouchStart(e) {
        const target = e.target.closest('.block');
        if (target) {
            e.preventDefault();
            const sourceColumn = target.closest('.column');
            draggedElementInfo = { element: target, type: target.dataset.type, source: target.dataset.source, fromRowId: sourceColumn ? sourceColumn.dataset.rowId : null };
            target.classList.add('dragging');
        }
    }

    function handleTouchMove(e) {
        if (!draggedElementInfo) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
        const trashCan = document.getElementById('trash-can');

        if (elementUnderTouch && elementUnderTouch.closest('#trash-can')) {
            trashCan.classList.add('active');
        } else {
            trashCan.classList.remove('active');
        }
    }

    function handleTouchEnd(e) {
        if (!draggedElementInfo) return;
        
        const touch = e.changedTouches[0];
        const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
        
        executeDrop(dropTarget, draggedElementInfo, touch.clientX, touch.clientY);

        draggedElementInfo.element.classList.remove('dragging');
        document.getElementById('trash-can').classList.remove('active');
        draggedElementInfo = null;
        lastTouchTarget = null;
    }

    // --- Main Setup and Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const mainContainer = document.querySelector('.main-container');
        const mainContent = document.querySelector('.main-content');
        const sidePanel = document.querySelector('.side-panel');
        
        let problemHTML = '';
        const rows = ['row1', 'row2'];
        rows.forEach(rowId => {
            const prefix = rowId === 'row1' ? 'num1' : 'num2';
            const opSymbol = rowId === 'row1' 
                ? `<div class="operation-symbol"></div>` 
                : `<div class="operation-symbol">
                       <select id="operation"><option value="+">+</option><option value="-">-</option></select>
                       <span class="op-instructions">Click to change</span>
                   </div>`;
            problemHTML += `<div class="number-row" id="${rowId}">${opSymbol}`;
            PLACES.forEach((p, i) => {
                problemHTML += `<div class="place-value-group ${p}-group">`;
                problemHTML += `<span class="column-label">${p.charAt(0).toUpperCase() + p.slice(1)}</span>`;
                if (rowId === 'row1') {
                    problemHTML += `<div class="carry-box">`;
                    const carryPlaces = ['hundreds', 'tens', 'ones', 'tenths'];
                    if (carryPlaces.includes(p)) {
                        problemHTML += `<input type="number" class="carry-input" id="carry-${p}" data-place="${p}">`;
                    }
                    problemHTML += `</div>`;
                }
                problemHTML += `<div class="column" data-row-id="${rowId}" data-place="${p}"></div><input type="number" class="digit-input" id="${prefix}-${p}"></div>`;
                if (p === 'ones') problemHTML += `<div class="decimal-point">.</div>`;
            });
            problemHTML += `</div>`;
        });
        
        let answerHTML = `<div class="number-row" id="answerRow"><div class="operation-symbol"></div>`;
        PLACES.forEach((p, i) => {
            answerHTML += `<div class="place-value-group ${p}-group"><span class="column-label">${p.charAt(0).toUpperCase() + p.slice(1)}</span><div class="column" data-row-id="answerRow" data-place="${p}"></div><input type="number" class="digit-input" id="ans-${p}"></div>`;
            if (p === 'ones') answerHTML += `<div class="decimal-point">.</div>`;
        });
        answerHTML += `</div>`;

        mainContent.innerHTML = `<div class="problem-area">${problemHTML}</div><hr><div class="answer-section">${answerHTML}<div class="controls"><button id="checkBtn">Check Answer</button><button id="nextProblemBtn">Next Problem</button></div><div class="feedback" id="feedback"></div></div>`;
        
        let paletteHTML = `<h3>Block Bank</h3>`;
        PLACES.forEach(p => {
            paletteHTML += `<div class="block ${p}" data-type="${p}" data-source="palette" draggable="true">${p === 'tenths' ? '.1' : p === 'hundredths' ? '.01' : ''}</div>`;
        });
        sidePanel.innerHTML = `<button id="toggle-labels-btn">Show/Hide Labels</button><div class="block-palette">${paletteHTML}</div><button id="clearAllBtn">Clear All</button><div id="trash-can" title="Drag blocks here to delete">🗑️</div><button id="clearAnswerBtn">Clear Answer</button>`;

        // --- Initialize and attach event listeners ---
        nextProblem();
        toggleCarryRow();

        document.querySelectorAll('.digit-input').forEach(input => { input.addEventListener('input', () => { const rowId = input.closest('.number-row')?.id; const prefix = rowId.startsWith('row1') ? 'num1' : rowId.startsWith('row2') ? 'num2' : 'ans'; updateBlocksFromInputs(prefix, rowId); }); });
        document.getElementById('checkBtn').addEventListener('click', checkAnswer);
        document.getElementById('nextProblemBtn').addEventListener('click', nextProblem);
        document.getElementById('clearAllBtn').addEventListener('click', clearAll);
        document.getElementById('clearAnswerBtn').addEventListener('click', clearAnswer);
        document.getElementById('toggle-labels-btn').addEventListener('click', () => mainContainer.classList.toggle('labels-hidden'));
        document.getElementById('operation').addEventListener('change', () => { nextProblem(); toggleCarryRow(); });

        // Mouse Drag Events
        document.addEventListener('dragstart', (e) => { if (e.target.classList.contains('block')) { const sourceColumn = e.target.closest('.column'); draggedElementInfo = { element: e.target, type: e.target.dataset.type, source: e.target.dataset.source, fromRowId: sourceColumn ? sourceColumn.dataset.rowId : null }; setTimeout(() => e.target.classList.add('dragging'), 0); } });
        document.addEventListener('dragend', (e) => { if (draggedElementInfo) { draggedElementInfo.element.classList.remove('dragging'); draggedElementInfo = null; } });
        
        const trashCan = document.getElementById('trash-can');
        trashCan.addEventListener('dragover', e => e.preventDefault());
        trashCan.addEventListener('dragenter', () => trashCan.classList.add('active'));
        trashCan.addEventListener('dragleave', () => trashCan.classList.remove('active'));
        trashCan.addEventListener('drop', e => { e.preventDefault(); executeDrop(trashCan, draggedElementInfo); trashCan.classList.remove('active'); });

        document.querySelectorAll('.column, .carry-box').forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('drop', e => {
                e.preventDefault();
                executeDrop(zone, draggedElementInfo, e.clientX, e.clientY);
            });
        });

        // Touch Drag Events
        document.addEventListener('touchstart', handleTouchStart, { passive: false });
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd);
    });
</script>
</body>
</html>
